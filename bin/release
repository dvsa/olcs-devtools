#!/bin/bash

BRANCH="master"
STASHED=false
SKIP_TAG=false
while getopts "hbs:" opt; do
  case $opt in
    h)
        echo;
        echo Tag and release a new version of this package to nexus
        echo Usage: release 4.204.1
        echo;
        echo "  -h          Show help (this)"
        echo "  -b <branch> Branch to create tag from if not master"
        echo "  -s skip creating a tag. Useful if creating package from existing tag"
        echo;
        exit;
      ;;
    b)
        BRANCH=$OPTARG
      ;;
    s)
        SKIP_TAG=true
        ;;
    *)
    ;;
  esac
done

if [ "$1" != "" ]; then
    VERSION="$1"
else
    echo;
    echo Please provide the version to tag the package as.
    echo "eg:   release 4.204.1"
    exit;
fi

WORKING_BRANCH=`git rev-parse --abbrev-ref HEAD`
if [ "$WORKING_BRANCH" != "$BRANCH" ]; then
	if [[ `git status --porcelain` ]]; then
	    git stash --all
	    STASHED=true
	fi
    git checkout "$BRANCH"
fi

git pull
if [ "$SKIP_TAG" == false ]; then
    git tag -a "$VERSION" -m "$VERSION"
    git push origin "$VERSION"
fi

composer nexus-push "$VERSION"

if [ "$BRANCH" != "$WORKING_BRANCH" ]; then
    git checkout "$WORKING_BRANCH"
    [ "$STASHED" == true ] && git stash pop
fi

exit 0