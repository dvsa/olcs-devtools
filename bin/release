#!/bin/bash

BRANCH="master"
STASHED=false
while getopts "hb:" opt; do
  case $opt in
    h)
        echo;
        echo Tag and release a new version of this package to nexus
        echo Usage: release 4.204.1
        echo;
        echo "  -h          Show help (this)"
        echo "  -b <branch> Branch to create tag from if not master"
        echo;
        exit;
      ;;
    b)
        BRANCH=$OPTARG
      ;;
    *)
    ;;
  esac
done

if [ "$1" != "" ]; then
    VERSION="$1"
else
    echo;
    echo Please provide the version to tag the package as.
    echo "eg:   release 4.204.1"
    exit;
fi

if [[ `git status --porcelain` ]]; then
    git stash
    STASHED=true
fi

git checkout "$BRANCH"
git pull
git tag -a "$VERSION" -m "$VERSION"
git push origin "$VERSION"

composer nexus-push "$VERSION"

[ $STASHED ] && git stash pop

